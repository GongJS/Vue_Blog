---
title: å®ç°å‘˜å·¥çš„å¢åˆ æ”¹æŸ¥
comments: true
---

è¿™éƒ¨åˆ†å°±æ˜¯åå°ç³»ç»Ÿå¾ˆå¸¸è§çš„åŠŸèƒ½ã€ä¹Ÿæ˜¯ä¸»è¦çš„åŠŸèƒ½äº†,æŠŠè¿™éƒ¨åˆ†å†…å®¹éƒ½å®Œæˆäº†ï¼Œä¸€ä¸ªåå°çš„ç®¡ç†ç³»ç»Ÿä¹ŸåŸºæœ¬å®Œæˆçš„ä¸ƒä¸ƒå…«å…«äº†ã€‚

## å‘é€ Token

å‰é¢åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡å™¨ä¼šç»™å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª tokenï¼Œé‚£ä¹ˆä»¥åå®¢æˆ·ç«¯æ¯æ¬¡å‘é€è¯·æ±‚éƒ½è¦å¸¦ä¸Š tokenï¼ŒæœåŠ¡å™¨éªŒè¯é€šè¿‡äº†æ‰ä¼šè¿”å›æ•°æ®ã€‚
å› ä¸ºæˆ‘ä»¬ç”¨äº†`koa-jwt`ï¼Œæ‰€ä»¥åªéœ€è¦åœ¨æ¯æ¡è¯·æ±‚å¤´ä¸ŠåŠ ä¸Š`Authorization`å±æ€§ï¼Œå€¼æ˜¯`Bearer {tokenå€¼}`ï¼Œç„¶åè®© Koa åœ¨æ¥æ”¶è¯·æ±‚ä¹‹å‰éªŒè¯ä¸€ä¸‹ token å³å¯ï¼Œæˆ‘ä»¬æŠŠ`token`ç»‘å®šåˆ°`axios`çš„`header`é‡Œï¼Œè¿™æ ·æ¯æ¬¡å‘é€è¯·æ±‚é»˜è®¤éƒ½ä¼šå¸¦ä¸Š`token`äº†ã€‚

æ‰“å¼€`src/main.js`ï¼Œåœ¨è·¯ç”±è·³è½¬çš„é’©å­é‡ŒåŠ ä¸Šè¿™å¥ï¼š

```js
//main.js

...
router.beforeEach((to, from, next) => {
  const token = sessionStorage.getItem('demo-token')
  if (to.meta.requiresAuth) {
    if (token !== 'null' && token != null) {
      // å…¨å±€è®¾å®šheaderçš„tokenéªŒè¯,æ³¨æ„Beareråæœ‰ä¸ªç©ºæ ¼
      Vue.prototype.$http.defaults.headers.common['Authorization'] = 'Bearer ' + token
      next()
    } else {
      message.warning('è¯·å…ˆç™»å½•')
      next('/login')
    }
  } else {
    next()
  }
})
```

## è·å–æ•°æ®

æˆ‘ä»¬å…ˆåœ¨æ•°æ®åº“é‡Œæ‰‹åŠ¨æ·»åŠ ä¸€æ¡æ•°æ®ï¼Œç„¶åå†å†™ä¸€ä¸ªè·å–æ•°æ®åº“é‡Œæ•°æ®çš„æ–¹æ³•ã€‚

<div style="text-align: center"><img src="./images/baobao.jpg"></div>

æ‰“å¼€`server/models/management.js`ï¼Œæ–°å¢ä¸€ä¸ª`getOperator`æ–¹æ³•ï¼š

```js
//models/management.js

import db from '../config/db.js' // å¼•å…¥userçš„è¡¨ç»“æ„
const managementModel = '../schema/management.js'
const DemoDb = db.Demo // å¼•å…¥æ•°æ®
const Management = DemoDb.import(managementModel) // ç”¨sequelizeçš„importæ–¹æ³•å¼•å…¥è¡¨ç»“æ„
const getOperator = async function(params) {
  const result = await personnelTable.findAndCountAll({
    offset: (params.page - 1) * params.pageSize,
    limit: params.pageSize
  })
  return result // è¿”å›æ•°æ®
}
export default {
  getOperator
}
```

é€šå¸¸æ•°æ®åº“é‡Œçš„æ•°æ®éƒ½æ˜¯æˆåƒä¸Šä¸‡æ¡çš„ï¼Œå¦‚æœä¸€æ¬¡æ€§è·å–å…¨éƒ¨æ•°æ®ï¼Œä¸€æ¥æ˜¯æ•°æ®åº“è¯»å–é€Ÿåº¦æ…¢ï¼ŒäºŒæ¥å‰ç«¯é¡µé¢ä¸€ä¸‹å­æ¸²æŸ“è¿™ä¹ˆå¤šæ•°æ®ä¹Ÿä¼šéœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨åˆ†é¡µè¿™ç§å‹å¥½çš„æ–¹å¼å»è·å–æ•°æ®ï¼Œè¿™é‡Œé€‰ç”¨é‡Œ`findAndCountAll`è¿™ä¸ªæ–¹æ³•ï¼Œ`offset`è¡¨ç¤ºé¡µç ï¼Œ`limit`è¡¨ç¤ºæ¯é¡µçš„æ•°æ®æ¡æ•°ï¼›å¦‚æœè¦ä¸€æ¬¡æ€§è·å–å…¨éƒ¨çš„æ•°æ®ï¼Œå¯ä»¥ç”¨`findAll`è¿™ä¸ªæ–¹æ³•ã€‚

åŒæ ·éœ€è¦ä¿®æ”¹`controller/management.js`:

```js
//controllers/management.js

import management from '../models/management.js'
import moment from 'moment'
import 'moment/locale/zh-cn'
moment.locale('zh-cn')

const getOperator = async function(ctx, next) {
  const data = ctx.request.body
  const result = await management.getOperator(data)
  if (result !== null) {
    ctx.response.body = {
      success: true,
      result: result
    }
  } else {
    ctx.response.body = {
      success: false,
      data: 'è·å–æ•°æ®å‡ºé”™'
    }
  }
}

export default {
  getOperator
}
```

æ›´æ–°è·¯ç”±`routes/router.js`:

```js
//routes/router.js
import ManagementController from './../controllers/management.js'
import jwt from 'koa-jwt'
...

export default function (app) {
  router.post('/user/:id', UserController.getUserInfo)
  router.post('/api/user', UserController.getUserAuth)
  router.post('/api/getOperator', jwt({secret: 'vue-koa-demo'}), ManagementController.getOperator)
```

è¿™é‡Œçš„`jwt({secret: 'vue-koa-demo'})`å°±æ˜¯è¦æ±‚å‰ç«¯å¦‚æœæƒ³è·å–`/api/getOperator`è¿™ä¸ª API çš„æ•°æ®ï¼Œå°±å¿…é¡»å¸¦ä¸Š`token`ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰ç”¨æˆ·ç™»å½•æˆåŠŸåæœåŠ¡å™¨è¿”å›ç»™ç”¨æˆ·çš„`token`ï¼Œæˆ‘ä»¬åœ¨ä¸Šæ–‡å·²ç»æŠŠè¿™ä¸ª`token`ç»‘å®šåˆ°`axios`çš„è¯·æ±‚å¤´ä¸Šäº†ã€‚

ä¿®æ”¹`app.js`,æ•æ‰`jwt`éªŒè¯å¤±è´¥çš„é”™è¯¯ä¿¡æ¯ï¼š

```js
//app.js
...
app.use(async function (ctx, next) {  //  å¦‚æœJWTéªŒè¯å¤±è´¥ï¼Œè¿”å›éªŒè¯å¤±è´¥ä¿¡æ¯
  try {
    await next()
  } catch (err) {
    if (err.status === 401) {
      ctx.status = 401
      ctx.body = {
        success: false,
        token: null,
        info: 'æ²¡æœ‰æƒé™'
      }
    } else {
      throw err
    }
  }
})

app.on('error', function (err, ctx) {
  console.log('server error', err)
})
...
```

æ¥ç€æˆ‘ä»¬éœ€è¦åœ¨å‰ç«¯å‘èµ·æ•°æ®çš„è¯·æ±‚äº†ï¼Œè¿™ä¸ªè¯·æ±‚åº”è¯¥åœ¨æˆ‘ä»¬é¡µé¢åˆšåŠ è½½çš„æ—¶å€™å°±å»æœåŠ¡å™¨é‡Œè¯·æ±‚æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨`mounted()`æ–¹æ³•é‡Œé¢è°ƒç”¨è·å–æ•°æ®çš„æ–¹æ³•ï¼Œä¿®æ”¹`src/components/userTable.vue`:

```js
//userTable.vue
...

 // åŠ¨æ€è·å–æ•°æ®
     async request () {
      let _this = this
      let url = '/api/getOperator'
      let params = this.params
      this.$http.post(url,params)
        .then(res => {
          res.data.result.rows.map((item, index) => {
            item.key = index
          })    //ç»™æ¯æ¡æ•°æ®æ·»åŠ å”¯ä¸€çš„keyå€¼
          _this.total = res.data.result.count
          _this.dataSource = res.data.result.rows
        })
    },

 mounted () {
    this.request()
  }
...
```

ç„¶åæˆ‘ä»¬åˆ·æ–°ä¸€ä¸‹é¡µé¢ï¼Œä¼šå‘ç°æˆ‘ä»¬å·²ç»æ‹¿åˆ°åˆšæ‰æ·»åŠ åˆ°æ•°æ®åº“é‡Œé¢çš„ä¸¤æ¡æ•°æ®äº†ï¼š

<img-wrapper>
<img src="./images/get.jpg"/>
</img-wrapper>

## æ·»åŠ æ•°æ®ã€æ›´æ–°æ•°æ®ã€åˆ é™¤æ•°æ®

ä¸Šå›¾ä¸­çš„å››ä¸ªæŒ‰é”®åŠŸèƒ½`åˆ›å»ºå‘˜å·¥` `ç¼–è¾‘å‘˜å·¥` `å‘˜å·¥è¯¦æƒ…` `åˆ é™¤å‘˜å·¥`åœ¨å‰ç«¯é¡µé¢é‡Œéƒ½å…±ç”¨äº†ä¸€ä¸ª modelï¼Œæ‰€ä»¥æ‰“ç®—æŠŠå››ä¸ªæŒ‰é”®åŠŸèƒ½çš„æ–¹æ³•ä¹Ÿé€šè¿‡å°è£…çš„æ–¹å¼å†™åœ¨ä¸€èµ·ã€‚

ä¿®æ”¹`server/models/management.js`:

```js
//models/management.js
...

// æ–°å¢æ•°æ®
const createOperator = async function (data){
  const userInfo = await Management.create({ // ç”¨awaitæ§åˆ¶å¼‚æ­¥æ“ä½œï¼Œå°†è¿”å›çš„Promiseå¯¹è±¡é‡Œçš„æ•°æ®è¿”å›å‡ºæ¥ã€‚ä¹Ÿå°±å®ç°äº†â€œåŒæ­¥â€çš„å†™æ³•è·å–å¼‚æ­¥IOæ“ä½œçš„æ•°æ®
      username: data.username,
      sex: data.sex,
      state: data.state,
      interest: data.interest,
      birthday: data.birthday
  });
  return userInfo // è¿”å›æ•°æ®
}

// æ›´æ–°æ•°æ®
const updateOperator = async function (data) {
  const result = await Management.update(
    {
      username: data.username,
      sex: data.sex,
      state: data.state,
      interest: data.interest,
      birthday: data.birthday
    },
    {
      where: {
        id: data.id
      }
    }
  )
  return result // è¿”å›æ•°æ®
}

//åˆ é™¤æ•°æ®
const deleteOperator = async function (params) {
  const result = await Management.destroy({
    where: {
      id: params.id
    }
  })
  return result // è¿”å›æ•°æ®
}

export default {
  createOperator, // å¯¼å‡ºcreateOperatorçš„æ–¹æ³•ï¼Œå°†ä¼šåœ¨controlleré‡Œè°ƒç”¨
  getOperator,
  deleteOperator,
  updateOperator
}
...
```

åŒæ ·éœ€è¦ä¿®æ”¹`controller/management.js`:

```js
//controller/management.js
...

//æ›´æ–°æ•°æ®
const updateOperator = async function (ctx, next) {
  const data = ctx.request.body
  data.birthday = moment(data.birthday).format('YYYY-MM-DD')
  const result = await management.updateOperator(data)
  if (result !== null) {
    ctx.response.body = {
      success: true,
      result: result
    }
  } else {
    ctx.response.body = {
      success: false,
      result: 'æ›´æ–°å¤±è´¥'
    }
  }
}

//åˆ é™¤æ•°æ®
const deleteOperator = async function (ctx, next) {
  const data = ctx.request.body
  const result = await management.deleteOperator(data)
  if (result > 0) {
    ctx.response.body = {
      success: true,
      result: 'åˆ é™¤æˆåŠŸ'
    }
  } else {
    ctx.response.body = {
      success: false,
      data: 'åˆ é™¤å¤±è´¥'
    }
  }
}

export default {
  createOperator, // å¯¼å‡ºcreateOperatorçš„æ–¹æ³•ï¼Œå°†ä¼šåœ¨router.jsé‡Œè°ƒç”¨
  getOperator,
  deleteOperator,
  updateOperator
}
```

æ›´æ–°è·¯ç”±`routes/router.js`:

```
`routes/router.js`
...

router.post('/api/createOperator', jwt({secret: 'vue-koa-demo'}), ManagementController.createOperator)
  router.post('/api/deleteOperator', jwt({secret: 'vue-koa-demo'}), ManagementController.deleteOperator)
  router.post('/api/updateOperator', jwt({secret: 'vue-koa-demo'}), ManagementController.updateOperator)

  ...
```

ä¿®æ”¹`userForm.vue`é‡Œé¢çš„`handleCreate`æ–¹æ³•ï¼š

```js
//userForm.vue
import { Form, Select, Radio, message } from 'ant-design-vue'
import moment from 'moment'
const FormItem = Form.Item
const Option = Select.Option
const RadioGroup = Radio.Group
...

async handleCreate  () {
      const form = this.formRef.form
      let _this = this
      form.validateFields(async (err, values) => {
        if (err) {
          return
        }
        let params = {
          username: values.username,
          sex: values.sex,
          state: values.state,
          birthday: values.birthday,
          interest: values.interest,
          id: _this.title === 'åˆ›å»ºå‘˜å·¥' ? null : _this.userInfo.id
        }
        let url= _this.title === 'åˆ›å»ºå‘˜å·¥' ? '/api/createOperator' : '/api/updateOperator'
        this.$http.post(url,params)
          .then((res) => {
            if (res.data.id ) {
              message.success('åˆ›å»ºæˆåŠŸ')
              form.resetFields()
              _this.$emit('hideForm', 'update')
            }
            if (res.data.result.length) {
              message.success('æ›´æ–°æˆåŠŸ')
              _this.$emit('hideForm', 'update', params)
            }
          })
      })
    },
```

æœ€åä¿®æ”¹`Helloword.vue`é‡Œé¢çš„`handleOperator`:

```js
//Helloword.vue
import { Modal, message } from 'ant-design-vue'
import UserTable from './UserTable'
import UserForm from './UserForm'
import SearchForm from './SearchForm'
...
//æ“ä½œå‘˜å·¥
    // æ“ä½œå‘˜å·¥
    handleOperator (type) {
      let _this = this
      let deleteId
      if (type === 'create') {
        this.title = 'åˆ›å»ºå‘˜å·¥'
        this.visible = true
        // å› ä¸ºå…±ç”¨ä¸€ä¸ªFormè¡¨å•ï¼Œå½“ç”¨æˆ·æ–°å»ºå‘˜å·¥æ—¶ï¼Œå³ä½¿é€‰ä¸­äº†tableé‡Œé¢çš„æŸä¸€è¡Œæ•°æ®ï¼Œæ‰“å¼€çš„Fromè¡¨å•åº”è¯¥åªæœ‰é»˜è®¤å€¼ï¼Œæ‰€ä»¥è¿™é‡Œè¦æ¸…ç©ºuserInfoï¼›é€šè¿‡selectItemæ¥åˆ¤æ–­ç”¨æˆ·æœ‰æ²¡æœ‰é€‰ä¸­tableçš„æ•°æ®
        this.userInfo = null
      } else if (type === 'edit' || type === 'detail') {
        if (this.selectItem.id == undefined) {
          Modal.info({
            title: 'ä¿¡æ¯',
            content: 'è¯·é€‰æ‹©ä¸€ä¸ªç”¨æˆ·'
          })
          return
        }
        this.title = (type === 'edit' ? 'ç¼–è¾‘ç”¨æˆ·' : 'ç”¨æˆ·è¯¦æƒ…')
        this.visible = true
        this.userInfo = this.selectItem
      } else if (type === 'delete') {
        deleteId = this.selectItem.id
        if (this.selectItem.id  == undefined) {
          Modal.info({
            title: 'ä¿¡æ¯',
            content: 'è¯·é€‰æ‹©ä¸€ä¸ªç”¨æˆ·'
          })
          return
        }
        Modal.confirm({
          content: 'ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿ',
          onOk: async () => {
            let url = '/api/deleteOperator'
            let params = {
              id: deleteId
            }
            _this.$http.post(url,params)
               .then((res) => {
                  if (res.data.result === 'åˆ é™¤æˆåŠŸ') {
                    message.success('åˆ é™¤æˆåŠŸ')
                     this.requestList= !_this.requestList
                     this.selectItem.id = undefined
                     this.hackReset = false
                     this.$nextTick(() => {
                     this.hackReset = true
                     })
                  }
               })
           }
        })
      }
    },
```

å¥½äº†ï¼Œä¸‹é¢è®©æˆ‘ä»¬æ¥çœ‹ä¸‹æ•ˆæœï¼š

<img-wrapper>
<img src="./images/operator.gif"/>
</img-wrapper>

OKï¼æ²¡é—®é¢˜ã€‚

å¦‚æœçœ‹äº†ä»£ç ï¼Œä¼šå‘ç°å…¶å®æ“ä½œæ•°æ®åº“æ²¡æœ‰é‚£ä¹ˆéš¾(æ„Ÿè°¢å¤§ç¥ä»¬ ğŸ™)ï¼Œå¢ã€åˆ ã€æ”¹ã€æŸ¥åˆ†åˆ«éƒ½æœ‰å¯¹åº”çš„æ–¹æ³•å¯ä»¥è°ƒç”¨

## æ•°æ®æŸ¥æ‰¾

æœ€åï¼Œæˆ‘ä»¬åšä¸€ä¸‹æŒ‰æ¡ä»¶æŸ¥æ‰¾çš„åŠŸèƒ½ï¼Œè¿™ä¸ªæ•™ç¨‹å°±æ¥è¿‘å°¾å£°äº†ã€‚å…¶å®åšåˆ°è¿™é‡Œï¼Œæ•´ä¸ªå‰åç«¯äº¤äº’é€»è¾‘ï¼Œå¤§å®¶åº”è¯¥éƒ½å·²ç»æ¯”è¾ƒæ¸…æ¥šäº†ã€‚`router`ä½œä¸ºå‰ç«¯çš„è®¿é—®è·¯å¾„ï¼Œ`controllers`æ˜¯å‰åç«¯æ•°æ®äº¤äº’çš„ç¼“å†²å±‚ï¼Œ`model`æ˜¯åç«¯è®¿é—®æ•°æ®åº“çš„æ–¹æ³•ã€‚

ä¿®æ”¹`server/models/management.js`,æ–°å¢`searchOperator`æ–¹æ³•ï¼š

```js
//models/management.js`
...
// æŒ‰è®¾ç½®æ¡ä»¶è¿›è¡ŒæŸ¥æ‰¾
const searchOperator = async function (params) {
  params.state === 'å…¨éƒ¨' ? params.state = ['å’¸é±¼ä¸€æ¡', 'é£åæµªå­', 'åŒ—å¤§æ‰å­ä¸€æš', 'ç™¾åº¦FE', 'åˆ›ä¸šè€…'] : params.state = [params.state]
  params.sex === 'å…¨éƒ¨' ? params.sex = ['ç”·', 'å¥³'] : params.sex = [params.sex]
  const result = await Management.findAll({
    where: {
      state: {
        $in: params.state
      },
      sex: {
        $in: params.sex
      },
      birthday: {
        $between: [params.birthday[0], params.birthday[1]]
      }
    }
  })
  return result // è¿”å›æ•°æ®
}
...
```

ä¿®æ”¹`server/controllers/management.js`,æ–°å¢`searchOperator`æ–¹æ³•ï¼š

```js
controllers/management.js
...
const searchOperator = async function (ctx, next) {
  const data = ctx.request.body
  console.log(data)
  data.birthday[0] = moment(data.birthday[0]).format('YYYY-MM-DD')
  data.birthday[1] = moment(data.birthday[1]).format('YYYY-MM-DD')
  const result = await management.searchOperator(data)
  if (result !== null) {
    ctx.response.body = {
      success: true,
      result: result
    }
  } else {
    ctx.response.body = {
      success: false,
      data: 'è·å–æ•°æ®å‡ºé”™'
    }
  }
}
...
```

æ›´æ–°`routes/router.js`:

```js
// router.js`
...
router.post('/api/searchOperator', jwt({secret: 'vue-koa-demo'}), ManagementController.searchOperator)
...
```

æ›´æ”¹å‰ç«¯é¡µé¢`SearchFrom.vue`é‡Œé¢çš„`handleSubmit`æ–¹æ³•ï¼š

```js
handleSubmit (e) {
      e.preventDefault()
      this.form.validateFields((err, values) => {
        if (!err) {
          // å¦‚æœç”¨æˆ·æ²¡æœ‰é€‰æ‹©æ—¶é—´æ®µï¼Œå°±ç»™ä¸€ä¸ªå¤§èŒƒå›´çš„æ—¶é—´æ®µæœç´¢èŒƒå›´
          if (!values.birthday) {
            values.birthday = []
            values.birthday[0] = moment(new Date(1900, 0, 1)).format('YYYY-MM-DD')
            values.birthday[1] = moment(new Date(2100, 0, 1,)).format('YYYY-MM-DD')
          }
          this.$emit('searchOperator', values)
        }
      })
    },
```

æˆ‘ä»¬æ¥çœ‹ä¸‹æœ€ç»ˆçš„æ•ˆæœï¼š

<img-wrapper>
  <img src="./images/search.gif">
</img-wrapper>

å¤§åŠŸå‘Šæˆã€‚
