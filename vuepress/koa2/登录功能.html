<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>登录功能 | GongJS</title>
    <meta name="description" content="Talk is cheap. Show me the code.">
    <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.d11e3aca.css" as="style"><link rel="preload" href="/assets/js/app.0520fef4.js" as="script"><link rel="preload" href="/assets/js/37.d232fecd.js" as="script"><link rel="prefetch" href="/assets/js/2.86671cdf.js"><link rel="prefetch" href="/assets/js/3.0caab080.js"><link rel="prefetch" href="/assets/js/4.00ccf4fe.js"><link rel="prefetch" href="/assets/js/5.02970db1.js"><link rel="prefetch" href="/assets/js/6.bd367c89.js"><link rel="prefetch" href="/assets/js/7.788a7119.js"><link rel="prefetch" href="/assets/js/8.f73ebcf0.js"><link rel="prefetch" href="/assets/js/9.66b5a5d2.js"><link rel="prefetch" href="/assets/js/10.86098aa0.js"><link rel="prefetch" href="/assets/js/11.822b3671.js"><link rel="prefetch" href="/assets/js/12.eff3e382.js"><link rel="prefetch" href="/assets/js/13.7d70d8ee.js"><link rel="prefetch" href="/assets/js/14.92682225.js"><link rel="prefetch" href="/assets/js/15.fa351a0c.js"><link rel="prefetch" href="/assets/js/16.099c24a8.js"><link rel="prefetch" href="/assets/js/17.54d4624c.js"><link rel="prefetch" href="/assets/js/18.a798d32d.js"><link rel="prefetch" href="/assets/js/19.129cc470.js"><link rel="prefetch" href="/assets/js/20.725f29cc.js"><link rel="prefetch" href="/assets/js/21.e0b0aabe.js"><link rel="prefetch" href="/assets/js/22.d38c23a9.js"><link rel="prefetch" href="/assets/js/23.2a8a85fe.js"><link rel="prefetch" href="/assets/js/24.0ae907ec.js"><link rel="prefetch" href="/assets/js/25.9c4832fb.js"><link rel="prefetch" href="/assets/js/26.485e3694.js"><link rel="prefetch" href="/assets/js/27.477829a3.js"><link rel="prefetch" href="/assets/js/28.e7d9065f.js"><link rel="prefetch" href="/assets/js/29.8c7f8f5d.js"><link rel="prefetch" href="/assets/js/30.cee47b27.js"><link rel="prefetch" href="/assets/js/31.7c3bd45e.js"><link rel="prefetch" href="/assets/js/32.6fe0ef12.js"><link rel="prefetch" href="/assets/js/33.4765629e.js"><link rel="prefetch" href="/assets/js/34.f815ee86.js"><link rel="prefetch" href="/assets/js/35.0a96ed59.js"><link rel="prefetch" href="/assets/js/36.cde069ea.js"><link rel="prefetch" href="/assets/js/38.3b4b7130.js"><link rel="prefetch" href="/assets/js/39.5226c59f.js"><link rel="prefetch" href="/assets/js/40.2fb65380.js"><link rel="prefetch" href="/assets/js/41.0236eb4b.js"><link rel="prefetch" href="/assets/js/42.112a188f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d11e3aca.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">GongJS</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Blog</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/" class="nav-link">vuepress</a></li><li class="dropdown-item"><!----> <a href="/koa2/" class="nav-link router-link-active">koa2</a></li><li class="dropdown-item"><!----> <a href="/JS/" class="nav-link">JS</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/ES6/" class="nav-link">ES6</a></li><li class="dropdown-item"><!----> <a href="/js-cli/" class="nav-link">js-cli 脚手架</a></li><li class="dropdown-item"><!----> <a href="/material/" class="nav-link">物料平台</a></li></ul></div></div><div class="nav-item"><a href="/project/" class="nav-link">Project</a></div><div class="nav-item"><a href="/friends/" class="nav-link">Friends</a></div><div class="nav-item"><a href="/essay/" class="nav-link">随笔</a></div> <a href="https://github.com/gongjs/Vue_Blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Blog</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress/" class="nav-link">vuepress</a></li><li class="dropdown-item"><!----> <a href="/koa2/" class="nav-link router-link-active">koa2</a></li><li class="dropdown-item"><!----> <a href="/JS/" class="nav-link">JS</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/ES6/" class="nav-link">ES6</a></li><li class="dropdown-item"><!----> <a href="/js-cli/" class="nav-link">js-cli 脚手架</a></li><li class="dropdown-item"><!----> <a href="/material/" class="nav-link">物料平台</a></li></ul></div></div><div class="nav-item"><a href="/project/" class="nav-link">Project</a></div><div class="nav-item"><a href="/friends/" class="nav-link">Friends</a></div><div class="nav-item"><a href="/essay/" class="nav-link">随笔</a></div> <a href="https://github.com/gongjs/Vue_Blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div class="carbon-ads"></div> <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>koa2</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/koa2/" class="sidebar-link">全栈开发实战</a></li><li><a href="/koa2/启动koa服务.html" class="sidebar-link">启动koa服务</a></li><li><a href="/koa2/构建前端页面.html" class="sidebar-link">构建前端页面</a></li><li><a href="/koa2/搭建后端环境.html" class="sidebar-link">搭建后端环境</a></li><li><a href="/koa2/登录功能.html" class="active sidebar-link">登录功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/koa2/登录功能.html#json-web-token" class="sidebar-link">JSON-WEB-TOKEN</a></li><li class="sidebar-sub-header"><a href="/koa2/登录功能.html#axios" class="sidebar-link">Axios</a></li><li class="sidebar-sub-header"><a href="/koa2/登录功能.html#bcryptjs-密码加密" class="sidebar-link">bcryptjs-密码加密</a></li><li class="sidebar-sub-header"><a href="/koa2/登录功能.html#跨域" class="sidebar-link">跨域</a></li><li class="sidebar-sub-header"><a href="/koa2/登录功能.html#路由拦截" class="sidebar-link">路由拦截</a></li></ul></li><li><a href="/koa2/实现员工的增删改查.html" class="sidebar-link">实现员工的增删改查</a></li><li><a href="/koa2/项目部署.html" class="sidebar-link">项目部署</a></li><li><a href="/koa2/写在最后.html" class="sidebar-link">写在最后</a></li></ul></div></li></ul> </div> <div id="area" class="page"> <div class="content"><h2 id="json-web-token"><a href="#json-web-token" aria-hidden="true" class="header-anchor">#</a> JSON-WEB-TOKEN</h2> <p>用户的登录验证我们采用目前比较火的<code>JSON-WEB-TOKEN</code>验证方式，相比于基于 cookie 或者 session 的登录验证 jwt 是真正的无状态请求，不占用服务器的资源，不存在跨域的问题，简单说说
jwt 的原理:</p> <ul><li>用户输入账号密码登录，会把账户密码（密码用 md5 加密）发送给后端</li> <li>后端验证用户的账号和密码信息，如果匹配，就返回一个 TOKEN 给客户端；如果验证失败，就返回验证错误信息</li> <li>登录成功成功后，客户端会将服务器返回的 TOKE 保存下来（SessionStorage、LocalStorage）,之后要请求其他资源的时候，在请求头（Header）里带上这个 TOKEN 进行请求</li> <li>后面服务器在收到客户端的请求时，会先验证一下 TOKEN 是否有效，有效则返回请求的资源，无效则返回验证错误
更详细的关于<code>JSON-WEB-TOKEN</code>的介绍，可参考<a href="http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html" target="_blank" rel="noopener noreferrer">阮一峰的博客<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
通过这个 TOKEN 的方式，客户端和服务端之间的访问，是无状态的：也就是服务端不知道你这个用户到底还在不在线，只要你发送的请求头里的 TOKEN 是正确的我就给你返回你想要的资源。这样能够不占用服务端宝贵的空间资源，而且如果涉及到服务器集群，如果服务器进行维护或者迁移或者需要 CDN 节点的分配的话，无状态的设计显然维护成本更低。
安装<code>jwt</code>:</li></ul> <div class="language- extra-class"><pre class="language-text"><code>yarn add koa-jwt
</code></pre></div><p>在<code>models</code>里的<code>user.js</code>新加一个通过用户名查找用户的方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// models/user.js</span>
<span class="token comment">// ......</span>
<span class="token comment">// 前面的省略了</span>

<span class="token comment">// 新增一个方法，通过用户名查找</span>
<span class="token keyword">const</span> getUserByName <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    where<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      username<span class="token punctuation">:</span> name
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> userInfo
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  getUserById<span class="token punctuation">,</span> <span class="token comment">// 导出getUserById的方法，将会在controller里调用</span>
  getUserByName
<span class="token punctuation">}</span>
</code></pre></div><p>接着修改<code>controllers</code>里的<code>user.js</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// controllers/user.js</span>
<span class="token comment">// ......</span>
<span class="token comment">// 前面的省略了</span>

<span class="token comment">// 新增一个方法，通过用户名查找</span>
<span class="token keyword">const</span> getUserAuth <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body <span class="token comment">// post过来的数据存在request.body里</span>
  <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getUserByName</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果查无此用户会返回null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span>password <span class="token operator">!=</span> data<span class="token punctuation">.</span>password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        success<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// success标志位是方便前端判断返回是正确与否</span>
        info<span class="token punctuation">:</span> <span class="token string">'密码错误！'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果密码正确</span>
      <span class="token keyword">const</span> userToken <span class="token operator">=</span> <span class="token punctuation">{</span>
        name<span class="token punctuation">:</span> userInfo<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
        id<span class="token punctuation">:</span> userInfo<span class="token punctuation">.</span>id
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> secret <span class="token operator">=</span> <span class="token string">'vue-koa-demo'</span> <span class="token comment">// 指定密钥，这是之后用来判断token合法性的标志</span>
      <span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>userToken<span class="token punctuation">,</span> secret<span class="token punctuation">)</span> <span class="token comment">// 签发token</span>
      ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        success<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        token<span class="token punctuation">:</span> token <span class="token comment">// 返回token</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      success<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      info<span class="token punctuation">:</span> <span class="token string">'用户不存在！'</span> <span class="token comment">// 如果用户不存在返回用户不存在</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">提示</p> <p><code>userToken</code>里面的内容是可以自定义的，加密后存储在 token 里返回给前端，前端如果想拿到 token 里面的内容，需要解码，安装<code>koa-jwt</code>，从<code>koa-jwt</code>导入<code>jwt</code>，然后调用<code>jwt.decode(token)</code>拿到<code>userToken</code>里面的内容。</p></div> <p>更新一下<code>router.js</code>规则：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//router.js</span>

<span class="token keyword">import</span> KoaRouter <span class="token keyword">from</span> <span class="token string">'koa-router'</span>
<span class="token keyword">import</span> UserController <span class="token keyword">from</span> <span class="token string">'./../controllers/user.js'</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">KoaRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> UserController<span class="token punctuation">.</span>getUserInfo<span class="token punctuation">)</span>
  router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">,</span> UserController<span class="token punctuation">.</span>getUserAuth<span class="token punctuation">)</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>后端 API 写完了，我们开始写前端请求</p> <h2 id="axios"><a href="#axios" aria-hidden="true" class="header-anchor">#</a> Axios</h2> <p><a href="https://github.com/axios/axios" target="_blank" rel="noopener noreferrer">axios<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是一个基于 Promise 用于浏览器和 nodejs 的 HTTP 客户端,非常火，在 github 上已经有了将近 50000 个 star 了，具体的使用方法大家可以参考官网，文档写的非常详细。先安装一下<code>axios</code>:</p> <div class="language- extra-class"><pre class="language-text"><code>yarn add axios
</code></pre></div><p>在<code>src\main.js</code>里引入 axios，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// scr/main.js</span>

<span class="token comment">// ...</span>

<span class="token keyword">import</span> Axios <span class="token keyword">from</span> <span class="token string">'axios'</span>

Vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$http <span class="token operator">=</span> Axios <span class="token comment">// 绑定到Vue的$http实例上</span>

<span class="token comment">// ...</span>
</code></pre></div><p>修改<code>Login.vue</code>,编写登录方法<code>handleSubmit</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Login.vue</span>
<span class="token comment">// 省略前面的部分</span>

  methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">handleSubmit</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>form<span class="token punctuation">.</span><span class="token function">validateFields</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> values<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> values<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
            password<span class="token punctuation">:</span> values<span class="token punctuation">.</span>password
          <span class="token punctuation">}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>$http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span> <span class="token comment">// 将信息发送给后端</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// axios返回的数据都在res.data里</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 如果成功</span>
                sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'demo-token'</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token comment">// 用sessionStorage把token存下来</span>
                message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'登录成功'</span><span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token comment">// 进入后台管理页面，登录成功</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                 <span class="token keyword">this</span><span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>info<span class="token punctuation">)</span> <span class="token comment">// 登录失败，显示提示语</span>
                 sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'demo-token'</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 将token清空</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'请求错误！'</span><span class="token punctuation">)</span>
              sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'demo-token'</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token comment">// 将token清空</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>登录框里的<code>username</code>和<code>password</code>的值，<code>antd</code>这个框架都帮我们封装在了<code>this.form.validateFields((err, values)</code>里的<code>values</code>这个参数里面了。</p> <h2 id="bcryptjs-密码加密"><a href="#bcryptjs-密码加密" aria-hidden="true" class="header-anchor">#</a> bcryptjs-密码加密</h2> <p>以前，我们习惯前端用 md5 给信息加密再提交给后端，但是后来发现这种方式并不安全，因为 html 是明文传输，即使是加密后的数据也能被第三方截取，他们可以直接拿着加密后的信息去后端请求数据；所以前端加密并不太靠谱，最安全的方式是采用<code>https传输协议</code>，加密的步骤放在后端。为什么需要后端加密呢？假如你登录过的某个网站数据库被攻击导致数据泄露，而你的密码是以明文保存在数据库的，那么黑客就可以拿你的密码去撞库，因为我们经常好几个网站的密码都是相同的，那意味着一个网站被攻击，你其他的网站的数据也不安全了。
安装 bcryptjs：</p> <div class="language- extra-class"><pre class="language-text"><code>yarn add bcryptjs
</code></pre></div><p>在<code>controllers/user.js</code>引入<code>bcryptjs</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//controllers/user.js</span>
<span class="token keyword">import</span> bcrypt <span class="token keyword">from</span> <span class="token string">'bcryptjs'</span>
<span class="token comment">// 省略前面的部分</span>

 <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果查无此用户会返回null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>password<span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span>dataValues<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 验证密码是否正确</span>
      ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        success<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// success标志位是方便前端判断返回是正确与否</span>
        info<span class="token punctuation">:</span> <span class="token string">'密码错误！'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 如果密码正确</span>
<span class="token comment">// 省略后面的部分</span>
</code></pre></div><p>然后我们需要把我们数据库里<code>123</code>这个明文密码 bcrypt 化，加密后变为：<code>$2a$10$x3f0Y2SNAmyAfqhKVAV.7uE7RHs3FDGuSYw.LlZhOFoyK7cjfZ.Q6</code>，替换数据库里的<code>123</code>.</p> <div class="tip custom-block"><p class="custom-block-title">提示</p> <p>如果我们做注册功能，用户注册成功后提交到后端的密码，需要我们用 bcrypt 加密后再存到数据库里,不要把密码等敏感信息用明文的方式存到数据库里</p></div> <h2 id="跨域"><a href="#跨域" aria-hidden="true" class="header-anchor">#</a> 跨域</h2> <p>在进行前后端联调的时候，我们还得解决跨域的问题。像现在，我们的 koa 服务器跑在<code>3000</code>端口，而前端是跑在<code>webpack</code>为我们提供的<code>8080</code>端口，端口不一样，存在跨域的情况，没法直接传输数据。解决跨域通信的方法常用的两种方法：</p> <ol><li>服务端在请求头上加上<code>CORS</code>允许跨域，客户端即可用类似<code>axios</code>这样的工具跨域发送请求</li> <li>变成同域
如果使用第一种方法的话，可以借助<a href="https://github.com//cors" target="_blank" rel="noopener noreferrer">koajs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>这个中间件
如果前端人员也能自己解决跨域的问题，那我们就没必要麻烦后端了，这里我们选用第二种办法。
打开根目录下<code>config/index.js</code>文件，找到<code>dev</code>下的<code>proxyTable</code>，利用这个<code>proxyTable</code>这个代理工具，把外部的请求通过 webpack 转发给本地，也就把跨域请求变成同域请求了：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//config/index.js</span>

前面省略
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  dev<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Paths</span>
    assetsSubDirectory<span class="token punctuation">:</span> <span class="token string">'static'</span><span class="token punctuation">,</span>
    assetsPublicPath<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    proxyTable<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'/api'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          target<span class="token punctuation">:</span> <span class="token string">'http://localhost:3000'</span><span class="token punctuation">,</span>
          changeOrigin<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    省略<span class="token operator">...</span>
</code></pre></div><p><code>proxyTable</code>的作用是：当我们在组件里发出的请求地址是/api/xxxx 的时候，实际上请求的是http://localhost:3000/api/xxxx，由于webpack帮我们代理了localhost的3000端口的服务，所以我们可以把实际是跨域的请求当做是同域下的接口来调用。</p> <p>然后重新启动一下前端<code>webpack</code>服务，先<code>ctrl+c</code>退出当前进程，然后<code>yarn dev</code>或者<code>npm run dev</code>,输入网址<code>http://localhost:8080/#/login</code>,输入账号<code>test</code>,密码<code>123</code>,然后登录：</p> <div class="imgWrapper" data-v-2c224345><img src="/assets/img/login.86dd726b.gif" data-v-2c224345></div> <p>登录成功，我们打开浏览器的后台查看<code>Session Storage</code>:</p> <div class="imgWrapper" data-v-2c224345><img src="/assets/img/token.f5611172.jpg" data-v-2c224345></div> <p>后端返回给我们的<code>token</code>也已经被保存下来了。</p> <h2 id="路由拦截"><a href="#路由拦截" aria-hidden="true" class="header-anchor">#</a> 路由拦截</h2> <p>在前端服务刚启动的时候或者手动修改地址栏的地址改成<code>http://localhost:8080/</code>也会跳转到管理页面，这与我们的需求违背，我们需要用户登录成功后才能跳转到管理后台:</p> <div class="imgWrapper" data-v-2c224345><img src="/assets/img/unloginTest.15540c12.gif" data-v-2c224345></div> <p>这里就要用到后端给我们传回来的<code>token</code>,有 token 就说明我们的身份是经过验证的，可以跳转到后台管理页面，否则就是非法的。我们用<code>vue-router</code>做一下前端的全局拦截，打开<code>src/main.js</code>，加入以下内容：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//src/main.js</span>
前面省略
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>productionTip <span class="token operator">=</span> <span class="token boolean">false</span>
router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'demo-token'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>requiresAuth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!==</span> <span class="token string">'null'</span> <span class="token operator">&amp;&amp;</span> token <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//判断是否存在 token</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      message<span class="token punctuation">.</span><span class="token function">warning</span><span class="token punctuation">(</span><span class="token string">'请先登录'</span><span class="token punctuation">)</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>打开<code>src/router/index.js</code>,改成如下内容：</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">//src/router/index.js</span>
前面省略
routes<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">'HelloWorld'</span><span class="token punctuation">,</span>
      component<span class="token punctuation">:</span> HelloWorld<span class="token punctuation">,</span>
      meta<span class="token punctuation">:</span> <span class="token punctuation">{</span>requiresAuth<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>   <span class="token comment">//表示进入HelloWorld页面是需要验证的</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      path<span class="token punctuation">:</span> <span class="token string">'/login'</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">'Login'</span><span class="token punctuation">,</span>
      component<span class="token punctuation">:</span> Login
    <span class="token punctuation">}</span>
</code></pre></div><p>重启服务器<code>npm run dev</code>,或者直接清除浏览器缓存刷新网页，保证<code>token</code>被清除掉就行，会发现在未登录的情况下，无法跳转到后台管理页面，说明拦截功能生效了。</p> <div class="imgWrapper" data-v-2c224345><img src="/assets/img/loginTest.fcb80ab4.gif" data-v-2c224345></div></div> <div class="page-edit"><!----> <!----></div> <!----> <div class="bsa-cpc-wrapper"><div class="bsa-cpc"></div></div> <div class="vcomment"><div id="vcomments"></div></div></div> <!----></div></div>
    <script src="/assets/js/37.d232fecd.js" defer></script><script src="/assets/js/app.0520fef4.js" defer></script>
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?c3446600de53c605ba4f6c792e47dff9";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  </body>
</html>
